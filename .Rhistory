xlim=c(42,10)) +
# theme(axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) +
#theme(axis.line.y=element_blank(),
#      axis.ticks.y=element_blank(),
#      axis.text.y=element_blank(),
#      axis.title.y=element_blank()) +
labs(tag="D")
pD
pG <- ggplot() +
geom_violin(data=vls%>% filter(t %in% vertvals,obs < 40, obs > 0),aes(x=t,y=obs,group=t),
fill="#631879FF",alpha=0.1,col="black",draw_quantiles=c(0.025,0.5,0.975), trim=TRUE,scale="width",width=10) +
geom_jitter(data=vls %>% filter(t %in% vertvals,obs < 40, obs > 0) %>% sample_n(500), aes(x=t,y=obs),width=2,
size=0.5,col="black") +
geom_line(data=Ct_lower,aes(x=t,y=ct),col="#631879FF",size=1.25) +
geom_line(data=Ct_upper,aes(x=t,y=ct),col="#631879FF",size=1.25) +
geom_line(data=Ct_median,aes(x=t,y=ct),col="#631879FF",size=1.25) +
scale_y_continuous(trans="reverse",limits=c(40,10)) +
main_theme +
labs(y="Ct value", x="Days since start of outbreak") +
theme(legend.title=element_blank(),
legend.position=c(0.8,0.8),
axis.text.x = element_blank(),
axis.line.x=element_blank(),
#axis.ticks.x=element_blank(),
axis.ticks.length.x = unit(0.2,"cm"),
#panel.grid.minor.x=element_blank()
panel.grid.major=element_line(size=0.1,colour="grey40")) +
scale_x_continuous(limits=c(25,175), breaks=vertvals) +
labs(tag="E")
main_p1 <- (pA + pB +
pC + pD +
pG + pH +
pE + p3 +
plot_layout(ncol=2,byrow=TRUE,
widths=c(2.5,1)))
main_p1
main_p1 <- (pA + pB +
pC + pD +
pG + pH +
#pE + p3 +
plot_layout(ncol=2,byrow=TRUE,
widths=c(2.5,1)))
main_p1
source('~/Documents/GitHub/virosolver_paper/scripts/Fig1_new/panelF.R', echo=TRUE)
main_p1 <- (pA + pB +
pC + pD +
pG + pH +
#pE + p3 +
plot_layout(ncol=2,byrow=TRUE,
widths=c(2.5,1)))
main_p1
main_p1 <- (pA + pB +
pC + pD +
pG + pH +
pE + p3 +
plot_layout(ncol=2,byrow=TRUE,
widths=c(2.5,1)))
main_p1
pG <- ggplot() +
geom_violin(data=vls%>% filter(t %in% vertvals,obs < 40, obs > 0),aes(x=t,y=obs,group=t),
fill="#631879FF",alpha=0.1,col="black",draw_quantiles=c(0.025,0.5,0.975), trim=TRUE,scale="width",width=10) +
geom_jitter(data=vls %>% filter(t %in% vertvals,obs < 40, obs > 0) %>% sample_n(500), aes(x=t,y=obs),width=2,
size=0.5,col="black") +
geom_line(data=Ct_lower,aes(x=t,y=ct),col="#631879FF",size=1.25) +
geom_line(data=Ct_upper,aes(x=t,y=ct),col="#631879FF",size=1.25) +
geom_line(data=Ct_median,aes(x=t,y=ct),col="#631879FF",size=1.25) +
scale_y_continuous(trans="reverse",limits=c(40,10)) +
main_theme +
labs(y="Ct value", x="Days since start of outbreak") +
theme(legend.title=element_blank(),
legend.position=c(0.8,0.8),
axis.text.x = element_blank(),
axis.line.x=element_blank(),
axis.title.x=element_blank(),
#axis.ticks.x=element_blank(),
axis.ticks.length.x = unit(0.2,"cm"),
#panel.grid.minor.x=element_blank()
panel.grid.major=element_line(size=0.1,colour="grey40")) +
scale_x_continuous(limits=c(25,175), breaks=vertvals) +
labs(tag="E")
main_p1 <- (pA + pB +
pC + pD +
pG + pH +
pE + p3 +
plot_layout(ncol=2,byrow=TRUE,
widths=c(2.5,1)))
main_p1
p1 <- combined_dat %>%
ggplot() +
geom_smooth(aes(x=mean_rt,y=skew_ct),se=TRUE)+
geom_point(aes(x=mean_rt,y=skew_ct),size=2) +
geom_vline(xintercept=1,linetype="dashed") +
#scale_y_continuous(limits=c(-1.2,0),breaks=seq(-1.2,0,by=0.2)) +
main_theme +
ylab("Skewness of Ct distribution") +
xlab("Rt (posterior mean)") +
labs(tag="C")
p2 <- combined_dat %>%
ggplot() +
geom_smooth(aes(x=mean_rt,y=median_ct),se=TRUE)+
geom_point(aes(x=mean_rt,y=median_ct),size=2)+
geom_vline(xintercept=1,linetype="dashed") +
main_theme +
#scale_y_continuous(trans="reverse",limits=c(35,28),breaks=seq(28,35,by=1)) +
scale_y_continuous(trans="reverse") +
ylab("Median of Ct distribution") +
xlab("Rt (posterior mean)") +
labs(tag="D")
p3 <- ggplot(combined_dat) +
geom_point(aes(x=skew_ct,y=median_ct,col=mean_rt),alpha=0.9,size=2) +
scale_color_gradient2(low="green",mid="blue",high="red",midpoint=1,
limits=c(0,2),
guide=guide_colorbar(title="Rt",
barwidth=1,ticks=FALSE,barheight=4))+
#scale_x_continuous(limits=c(-1.2,0),breaks=seq(-1.2,0,by=0.2)) +
scale_y_continuous(trans="reverse")+#,limits=c(35,28),breaks=seq(28,35,by=1)) +
main_theme +
xlab("Skewness of Ct distribution") +
ylab("Median of Ct distribution") +
theme(legend.position=c(0.2,0.8),
legend.text=element_text(size=6),
legend.title=element_text(size=6)) +
labs(tag="E")
main_p1 <- (pA + pB +
pC + pD +
pG + pH +
pE + p3 +
plot_layout(ncol=2,byrow=TRUE,
widths=c(2.5,1)))
main_p1
p3 <- ggplot(combined_dat) +
geom_point(aes(x=skew_ct,y=median_ct,col=mean_rt),alpha=0.9,size=2) +
scale_color_gradient2(low="green",mid="blue",high="red",midpoint=1,
limits=c(0,2),
guide=guide_colorbar(title="Rt",
barwidth=1,ticks=FALSE,barheight=4))+
#scale_x_continuous(limits=c(-1.2,0),breaks=seq(-1.2,0,by=0.2)) +
scale_y_continuous(trans="reverse")+#,limits=c(35,28),breaks=seq(28,35,by=1)) +
main_theme +
xlab("Skewness of Ct distribution") +
ylab("Median of Ct distribution") +
theme(legend.position=c(0.2,0.8),
legend.text=element_text(size=6),
legend.title=element_text(size=6),
panel.grid.major=element_line(colour="grey40",size=0.1)) +
labs(tag="E")
main_p1 <- (pA + pB +
pC + pD +
pG + pH +
pE + p3 +
plot_layout(ncol=2,byrow=TRUE,
widths=c(2.5,1)))
main_p1
?margin
main_theme <- theme_classic() +
theme(axis.ticks.length.x = unit(0.2,"cm"),
text=element_text(family="sans"),
plot.margin = margin(-1,-1,-1,-1,unit="cm"),
panel.grid.minor.x=element_blank())
source("code/plot_funcs.R")
source("code/linelist_sim_funcs.R")
R0 <- 2
#### Viral Load Kinetics Parameters: ####
vl_pars <- read.csv("pars/massachusetts/partab_fitted_bwh.csv")
pars <- vl_pars$values
names(pars) <- vl_pars$names
source("scripts/Fig1_new/generate_sim_data.R")
source("scripts/Fig1_new/panelA.R")
source("scripts/Fig1_new/panelB.R")
source("scripts/Fig1_new/panelC.R")
source("scripts/Fig1_new/panelD.R")
source("scripts/Fig1_new/panelE.R")
source("scripts/Fig1_new/panelF.R")
source("scripts/Fig1_new/panelG.R")
p1 <- combined_dat %>%
ggplot() +
geom_smooth(aes(x=mean_rt,y=skew_ct),se=TRUE)+
geom_point(aes(x=mean_rt,y=skew_ct),size=2) +
geom_vline(xintercept=1,linetype="dashed") +
#scale_y_continuous(limits=c(-1.2,0),breaks=seq(-1.2,0,by=0.2)) +
main_theme +
ylab("Skewness of Ct distribution") +
xlab("Rt (posterior mean)") +
labs(tag="C")
p2 <- combined_dat %>%
ggplot() +
geom_smooth(aes(x=mean_rt,y=median_ct),se=TRUE)+
geom_point(aes(x=mean_rt,y=median_ct),size=2)+
geom_vline(xintercept=1,linetype="dashed") +
main_theme +
#scale_y_continuous(trans="reverse",limits=c(35,28),breaks=seq(28,35,by=1)) +
scale_y_continuous(trans="reverse") +
ylab("Median of Ct distribution") +
xlab("Rt (posterior mean)") +
labs(tag="D")
p3 <- ggplot(combined_dat) +
geom_point(aes(x=skew_ct,y=median_ct,col=mean_rt),alpha=0.9,size=2) +
scale_color_gradient2(low="green",mid="blue",high="red",midpoint=1,
limits=c(0,2),
guide=guide_colorbar(title="Rt",
barwidth=1,ticks=FALSE,barheight=4))+
#scale_x_continuous(limits=c(-1.2,0),breaks=seq(-1.2,0,by=0.2)) +
scale_y_continuous(trans="reverse")+#,limits=c(35,28),breaks=seq(28,35,by=1)) +
main_theme +
xlab("Skewness of Ct distribution") +
ylab("Median of Ct distribution") +
theme(legend.position=c(0.2,0.8),
legend.text=element_text(size=6),
legend.title=element_text(size=6),
panel.grid.major=element_line(colour="grey40",size=0.1)) +
labs(tag="E")
main_p1 <- (pA + pB +
pC + pD +
pG + pH +
pE + p3 +
plot_layout(ncol=2,byrow=TRUE,
widths=c(2.5,1)))
main_p1
ggsave(filename="figures/fig1_jh3.png",
plot=main_p1,
width=10, height=10, units="in", dpi=600)
ggsave(filename="schematics/fig1_jh3.pdf",
plot=main_p,
width=10, height=10, units="in", dpi=600)
ggsave(filename="figures/fig1_jh3.pdf",
plot=main_p,
width=10, height=10, units="in", dpi=600)
ggsave(filename="figures/fig1_jh3.pdf",
plot=main_p1,
width=10, height=10, units="in", dpi=600)
p1
p2
combined_dat <- simulated_viral_loads %>%
mutate(week=floor(sampled_time/7))%>%
group_by(week) %>%
mutate(first_day = min(sampled_time,na.rm=TRUE)) %>%
filter(ct_obs < pars["intercept"]) %>%
#filter(sampled_time >= min(use_days) & sampled_time <= max(use_days)) %>%
#group_by(sampled_time) %>%
#filter(ct_obs < kinetics_pars["intercept"]) %>%
group_by(week, first_day) %>%
summarize(median_ct=median(ct_obs),
skew_ct=moments::skewness(ct_obs),
n=n()) %>%
#rename(date=first_day) %>%
full_join(seir_weekly) #%>%
#filter(n >= 50)
p1 <- combined_dat %>%
ggplot() +
geom_smooth(aes(x=mean_rt,y=skew_ct),se=TRUE)+
geom_point(aes(x=mean_rt,y=skew_ct),size=2) +
geom_vline(xintercept=1,linetype="dashed") +
#scale_y_continuous(limits=c(-1.2,0),breaks=seq(-1.2,0,by=0.2)) +
main_theme +
ylab("Skewness of Ct distribution") +
xlab("Rt (posterior mean)") +
labs(tag="1")
p2 <- combined_dat %>%
ggplot() +
geom_smooth(aes(x=mean_rt,y=median_ct),se=TRUE)+
geom_point(aes(x=mean_rt,y=median_ct),size=2)+
geom_vline(xintercept=1,linetype="dashed") +
main_theme +
#scale_y_continuous(trans="reverse",limits=c(35,28),breaks=seq(28,35,by=1)) +
scale_y_continuous(trans="reverse") +
ylab("Median of Ct distribution") +
xlab("Rt (posterior mean)") +
labs(tag="2")
p1
p2
p1 <- combined_dat %>%
ggplot() +
geom_smooth(aes(x=mean_rt,y=skew_ct),se=TRUE)+
geom_point(aes(x=mean_rt,y=skew_ct),size=2) +
geom_vline(xintercept=1,linetype="dashed") +
#scale_y_continuous(limits=c(-1.2,0),breaks=seq(-1.2,0,by=0.2)) +
main_theme +
ylab("Skewness of Ct distribution") +
xlab("Rt (posterior mean)") +
labs(tag="A")
p2 <- combined_dat %>%
ggplot() +
geom_smooth(aes(x=mean_rt,y=median_ct),se=TRUE)+
geom_point(aes(x=mean_rt,y=median_ct),size=2)+
geom_vline(xintercept=1,linetype="dashed") +
main_theme +
#scale_y_continuous(trans="reverse",limits=c(35,28),breaks=seq(28,35,by=1)) +
scale_y_continuous(trans="reverse") +
ylab("Median of Ct distribution") +
xlab("Rt (posterior mean)") +
labs(tag="B")
p3 <- ggplot(combined_dat) +
geom_point(aes(x=skew_ct,y=median_ct,col=mean_rt),alpha=0.9,size=2) +
scale_color_gradient2(low="green",mid="blue",high="red",midpoint=1,
limits=c(0,2),
guide=guide_colorbar(title="Rt",
barwidth=1,ticks=FALSE,barheight=4))+
#scale_x_continuous(limits=c(-1.2,0),breaks=seq(-1.2,0,by=0.2)) +
scale_y_continuous(trans="reverse")+#,limits=c(35,28),breaks=seq(28,35,by=1)) +
main_theme +
xlab("Skewness of Ct distribution") +
ylab("Median of Ct distribution") +
theme(legend.position=c(0.2,0.8),
legend.text=element_text(size=6),
legend.title=element_text(size=6),
panel.grid.major=element_line(colour="grey40",size=0.1)) +
labs(tag="H")
p1
p2
combined_dat <- simulated_viral_loads %>%
mutate(week=floor(sampled_time/7))%>%
group_by(week) %>%
mutate(first_day = min(sampled_time,na.rm=TRUE)) %>%
filter(ct_obs < pars["intercept"]) %>%
#filter(sampled_time >= min(use_days) & sampled_time <= max(use_days)) %>%
#group_by(sampled_time) %>%
#filter(ct_obs < kinetics_pars["intercept"]) %>%
group_by(week, first_day) %>%
summarize(median_ct=median(ct_obs),
skew_ct=moments::skewness(ct_obs),
n=n()) %>%
#rename(date=first_day) %>%
full_join(seir_weekly) %>%
filter(n >= 50)
p1 <- combined_dat %>%
ggplot() +
geom_smooth(aes(x=mean_rt,y=skew_ct),se=TRUE)+
geom_point(aes(x=mean_rt,y=skew_ct),size=2) +
geom_vline(xintercept=1,linetype="dashed") +
#scale_y_continuous(limits=c(-1.2,0),breaks=seq(-1.2,0,by=0.2)) +
main_theme +
ylab("Skewness of Ct distribution") +
xlab("Rt (posterior mean)") +
labs(tag="A")
p2 <- combined_dat %>%
ggplot() +
geom_smooth(aes(x=mean_rt,y=median_ct),se=TRUE)+
geom_point(aes(x=mean_rt,y=median_ct),size=2)+
geom_vline(xintercept=1,linetype="dashed") +
main_theme +
#scale_y_continuous(trans="reverse",limits=c(35,28),breaks=seq(28,35,by=1)) +
scale_y_continuous(trans="reverse") +
ylab("Median of Ct distribution") +
xlab("Rt (posterior mean)") +
labs(tag="B")
p1
p2
p1 | p2
p1 | p2 | p3
p1 <- combined_dat %>%
ggplot() +
geom_smooth(aes(x=mean_rt,y=skew_ct),se=TRUE)+
geom_point(aes(x=mean_rt,y=skew_ct),size=2) +
geom_vline(xintercept=1,linetype="dashed") +
#scale_y_continuous(limits=c(-1.2,0),breaks=seq(-1.2,0,by=0.2)) +
main_theme +
ylab("Skewness of Ct distribution") +
xlab("Rt (posterior mean)") +
labs(tag="A")
p2 <- combined_dat %>%
ggplot() +
geom_smooth(aes(x=mean_rt,y=median_ct),se=TRUE)+
geom_point(aes(x=mean_rt,y=median_ct),size=2)+
geom_vline(xintercept=1,linetype="dashed") +
main_theme +
#scale_y_continuous(trans="reverse",limits=c(35,28),breaks=seq(28,35,by=1)) +
scale_y_continuous(trans="reverse") +
ylab("Median of Ct distribution") +
xlab("Rt (posterior mean)") +
labs(tag="B")
p3 <- ggplot(combined_dat) +
geom_point(aes(x=skew_ct,y=median_ct,col=mean_rt),alpha=0.9,size=2) +
scale_color_gradient2(low="green",mid="blue",high="red",midpoint=1,
limits=c(0,2),
guide=guide_colorbar(title="Rt",
barwidth=1,ticks=FALSE,barheight=4))+
#scale_x_continuous(limits=c(-1.2,0),breaks=seq(-1.2,0,by=0.2)) +
scale_y_continuous(trans="reverse")+#,limits=c(35,28),breaks=seq(28,35,by=1)) +
main_theme +
xlab("Skewness of Ct distribution") +
ylab("Median of Ct distribution") +
theme(legend.position=c(0.2,0.8),
legend.text=element_text(size=6),
legend.title=element_text(size=6),
panel.grid.major=element_line(colour="grey40",size=0.1)) +
labs(tag="H")
p1 | p2 | p3
p1 <- combined_dat %>%
ggplot() +
geom_smooth(aes(x=mean_rt,y=skew_ct),se=TRUE)+
geom_point(aes(x=mean_rt,y=skew_ct),size=2) +
geom_vline(xintercept=1,linetype="dashed") +
#scale_y_continuous(limits=c(-1.2,0),breaks=seq(-1.2,0,by=0.2)) +
main_theme +
ylab("Skewness of Ct distribution") +
xlab("Rt (posterior mean)") +
labs(tag="A")
p2 <- combined_dat %>%
ggplot() +
geom_smooth(aes(x=mean_rt,y=median_ct),se=TRUE)+
geom_point(aes(x=mean_rt,y=median_ct),size=2)+
geom_vline(xintercept=1,linetype="dashed") +
main_theme +
#scale_y_continuous(trans="reverse",limits=c(35,28),breaks=seq(28,35,by=1)) +
scale_y_continuous(trans="reverse") +
ylab("Median of Ct distribution") +
xlab("Rt (posterior mean)") +
labs(tag="B")
p3 <- ggplot(combined_dat) +
geom_point(aes(x=skew_ct,y=median_ct,col=mean_rt),alpha=0.9,size=2) +
scale_color_gradient2(low="green",mid="blue",high="red",midpoint=1,
limits=c(0,2),
guide=guide_colorbar(title="Rt",
barwidth=1,ticks=FALSE,barheight=4))+
#scale_x_continuous(limits=c(-1.2,0),breaks=seq(-1.2,0,by=0.2)) +
scale_y_continuous(trans="reverse")+#,limits=c(35,28),breaks=seq(28,35,by=1)) +
main_theme +
xlab("Skewness of Ct distribution") +
ylab("Median of Ct distribution") +
theme(legend.position=c(0.2,0.8),
legend.text=element_text(size=6),
legend.title=element_text(size=6),
panel.grid.major=element_line(colour="grey40",size=0.1)) +
labs(tag="H")
p1 | p2 | p3
R0
best_pars
main_wd <- "~/Documents/GitHub/ct_dynamics_preprint/"
setwd(main_wd)
##############################
## Model parameters
best_pars_fitting <- read.csv("pars/seir_fits_best_pars.csv")
best_pars <- as.numeric(best_pars_fitting[best_pars_fitting$institution == "NH 1",])
best_pars
names(best_pars) <- colnames(best_pars_fitting)
best_pars["R0"] <- 2
best_pars["I0"] <- 100/population_n
best_pars["t0"] <- 0
best_pars
seir_pars <- c("R0"=R0,"infectious"=9,"incubation"=6,"I0"=0.0001,"t0"=0)
names(seir_pars) <- c("R0","infectious","incubation","I0","t0")
epidemic_process <- simulate_seir_process(seir_pars,times,population_n)
## Simulate onset times, confirmation delays etc
observed_individuals <- simulate_observations_wrapper(incidence=epidemic_process$raw_incidence,times=times,
population_n=1000000)
## Random surveillance
observed_indivs_flat <- simulate_reporting(observed_individuals, frac_report=1,timevarying_prob=NULL,
solve_times=times, symptomatic=FALSE)
simulated_viral_loads <- simulate_viral_loads_wrapper(observed_indivs_flat$sampled_individuals,
kinetics_pars=pars)
seir_weekly <- epidemic_process$seir_outputs %>%
pivot_wider(names_from=variable,values_from=value) %>%
as_tibble() %>%
rename(sampled_time=time) %>%
mutate(week=floor(sampled_time/7))%>%
group_by(week) %>%
mutate(first_day = min(sampled_time,na.rm=TRUE)) %>%
group_by(week, first_day) %>%
summarize(mean_rt=mean(Rt))
combined_dat <- simulated_viral_loads %>%
mutate(week=floor(sampled_time/7))%>%
group_by(week) %>%
mutate(first_day = min(sampled_time,na.rm=TRUE)) %>%
filter(ct_obs < pars["intercept"]) %>%
#filter(sampled_time >= min(use_days) & sampled_time <= max(use_days)) %>%
#group_by(sampled_time) %>%
#filter(ct_obs < kinetics_pars["intercept"]) %>%
group_by(week, first_day) %>%
summarize(median_ct=median(ct_obs),
skew_ct=moments::skewness(ct_obs),
n=n()) %>%
#rename(date=first_day) %>%
full_join(seir_weekly) %>%
filter(n >= 50)
p1 <- combined_dat %>%
ggplot() +
geom_smooth(aes(x=mean_rt,y=skew_ct),se=TRUE)+
geom_point(aes(x=mean_rt,y=skew_ct),size=2) +
geom_vline(xintercept=1,linetype="dashed") +
#scale_y_continuous(limits=c(-1.2,0),breaks=seq(-1.2,0,by=0.2)) +
main_theme +
ylab("Skewness of Ct distribution") +
xlab("Rt (posterior mean)") +
labs(tag="A")
p2 <- combined_dat %>%
ggplot() +
geom_smooth(aes(x=mean_rt,y=median_ct),se=TRUE)+
geom_point(aes(x=mean_rt,y=median_ct),size=2)+
geom_vline(xintercept=1,linetype="dashed") +
main_theme +
#scale_y_continuous(trans="reverse",limits=c(35,28),breaks=seq(28,35,by=1)) +
scale_y_continuous(trans="reverse") +
ylab("Median of Ct distribution") +
xlab("Rt (posterior mean)") +
labs(tag="B")
p3 <- ggplot(combined_dat) +
geom_point(aes(x=skew_ct,y=median_ct,col=mean_rt),alpha=0.9,size=2) +
scale_color_gradient2(low="green",mid="blue",high="red",midpoint=1,
limits=c(0,2),
guide=guide_colorbar(title="Rt",
barwidth=1,ticks=FALSE,barheight=4))+
#scale_x_continuous(limits=c(-1.2,0),breaks=seq(-1.2,0,by=0.2)) +
scale_y_continuous(trans="reverse")+#,limits=c(35,28),breaks=seq(28,35,by=1)) +
main_theme +
xlab("Skewness of Ct distribution") +
ylab("Median of Ct distribution") +
theme(legend.position=c(0.2,0.8),
legend.text=element_text(size=6),
legend.title=element_text(size=6),
panel.grid.major=element_line(colour="grey40",size=0.1)) +
labs(tag="H")
p1 | p2 | p3
